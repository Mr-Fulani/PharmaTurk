# AI шаблоны: как они применяются к категориям и товарам

## Главное

- **Шаблоны** хранятся в **Админка → AI → AI шаблоны** (модель `AITemplate`).
- У шаблона есть поле **«Категория»** (необязательное). Оно ссылается на ту же таблицу категорий, что и поле **«Категория»** у товара.
- **Привязка к товарам:** при обработке товара берётся **категория товара** (`product.category`). Система ищет шаблон с таким же типом и **такой же категорией**. Если нашла — подставляет его в промпт. Если нет — ищет шаблон **без категории** (общий), иначе используется встроенный текст по умолчанию.

Итого: **шаблон «привязан» к категории**, а не к конкретному товару. Все товары с этой категорией получают этот шаблон при запуске AI.

---

## Типы шаблонов, которые учитывают категорию

В коде сейчас категория используется для двух типов:

| Тип шаблона              | Назначение | Когда подставляется |
|--------------------------|------------|----------------------|
| **Инструкция для категории** (`category_instruction`) | Текст инструкции для LLM (как писать описание/SEO для этой категории). | При генерации описания и SEO: в пользовательский промпт добавляется блок «Инструкции для категории «Название»: …». |
| **Анализ изображения** (`image_prompt`) | Промпт для Vision API (что спрашивать по картинке). | При анализе фото товара: если у товара есть категория, сначала ищется шаблон с этой категорией, иначе — общий или дефолт. |

Остальные типы (`Описание товара`, `Пример категории`, `Извлечение атрибутов`) используются через RAG (Qdrant): их контент индексируется и подбирается по **похожести текста** к названию/описанию товара, а не по полю «Категория» шаблона. После изменений таких шаблонов нужно запускать `setup_ai_rag`.

---

## Пошагово: как привязать шаблон к категории

### 1. Инструкция для категории (например, «Книги»)

1. Откройте **Админка → AI → AI шаблоны** → **Добавить**.
2. **Название** — любое уникальное, например: `Инструкция для книг`.
3. **Тип шаблона** — **«Инструкция для категории»**.
4. **Категория** — выберите категорию каталога, к которой относятся товары (например, «Книги» или «История»). Оставьте пустым, если инструкция общая для всех.
5. **Содержимое** — текст инструкции для модели, например:
   - «Для книг всегда указывай автора из описания или обложки. Не придумывай ISBN и издательство, если их нет в данных.»
6. Сохраните.

**Что будет:** при запуске AI для любого товара, у которого в карточке указана **та же категория** (например, «Книги»), этот текст попадёт в промпт как блок «Инструкции для категории «Книги»: …». Товары с другой категорией эту инструкцию не получат.

### 2. Промпт для анализа изображений по категории

1. **Админка → AI → AI шаблоны** → **Добавить**.
2. **Тип шаблона** — **«Анализ изображения»**.
3. **Категория** — при необходимости выберите категорию (например, «Книги»). Для общего промпта оставьте пустым.
4. **Содержимое** — что спрашивать у Vision по картинке, в формате, который модель вернёт JSON, например:
   - «Опиши обложку книги: автор, название, издательство, язык. Если виден ISBN — укажи. Ответ — JSON с полями author, title, publisher, language, isbn.»
5. Сохраните.

**Что будет:** при анализе фото товара с категорией «Книги» будет использован этот промпт (если он есть); для товаров без категории или с другой категорией — общий шаблон «Анализ изображения» без категории или встроенный дефолт.

---

## Важно про категорию товара

- Шаблон срабатывает только если у **товара** в карточке заполнено поле **«Категория»** и оно совпадает с категорией, выбранной в шаблоне.
- Если у товара категория не указана — используется только шаблон **без категории** (или дефолт).
- Категория в шаблоне и категория у товара — одна и та же модель каталога (`Category`), поэтому нужно выбирать ту же категорию, что и в карточке товара (например, та же «Книги» или подкатегория «История»).

---

## Кратко

| Вопрос | Ответ |
|--------|--------|
| Где создавать шаблоны? | Админка → AI → AI шаблоны. |
| Как привязать к категории? | В шаблоне выберите поле **«Категория»** = нужная категория каталога. |
| К каким товарам применяется? | Ко всем товарам, у которых в карточке указана **та же категория**. |
| Какие типы учитывают категорию? | **Инструкция для категории** (текст в промпт) и **Анализ изображения** (промпт для Vision). |
| Общие шаблоны без категории? | Оставьте **«Категория»** пустым — такой шаблон используется, когда нет подходящего шаблона с категорией. |
