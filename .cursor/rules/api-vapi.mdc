---
description:
globs:
alwaysApply: false
---
Принял ссылку на документацию. Ниже короткий план интеграции на базе `vapi.co` с учётом текущего кода и ваших требований. Источник: документация `vapi.co` [секции API и данных](https://doc.vapi.co/tr).

### План интеграции vapi.co

- Подготовка окружения
  - Добавить переменные: `VAPI_BASE_URL` (`https://api.vapi.co`), `VAPI_API_KEY`.
  - Прокидывать язык: `Accept-Language` (и/или `?lang=` если поддерживается) из текущей локали.

- Клиент и поддерживаемые разделы
  - Расширить `apps/vapi/client.py`:
    - Уже есть: список/поиск/детали товара, категории, бренды, взаимодействия, противопоказания.
    - Добавить методы под разделы из доков:
      - Цены: актуальные и «на будущую дату».
      - Документы: короткая инструкция, инструкция по применению, письмо врачу, изображения.
      - Монография.
      - Пациентские ярлыки.
      - Дозировки.
      - Действующие вещества, ATC (и индексы).
      - Аналоги и альтернативы.
      - Вендоры/компании.
      - Взаимодействия (уже есть) — расширить модель хранения.
    - Везде включать заголовок `Accept-Language`.

- Модели/сериализация (минимум изменений, максимум повторного использования)
  - Опираться на текущие модели `Product`, `ProductImage`, `ProductAttribute`:
    - Сохранение расширенных блоков в `ProductAttribute` с типами: `monograph`, `patient_labels`, `dosage`, `equivalents`, `alternatives`, `documents_short_info`, `documents_usage`, `doctor_letter`, `atc`, `active_ingredients`, `doping`.
    - Для детальных структур (документы, ценовая история) использовать:
      - `PriceHistory` (уже есть) + задачa для актуализации из vapi.
      - Новый `ProductDocument` (если нужно хранить ссылки/версии) либо JSON в `external_data`.
    - Категории/бренды: доп. локализация — хранить локализованные названия в `external_data` по ключам локали или в таблице переводов (если понадобится строгая M2M-модель переводов).
  - Сериализаторы (`apps/catalog/serializers.py`):
    - Расширить `ProductDetailSerializer` полями: `atc_code`, `rx_required`, `manufacturer`, `dosage_form`, `strength`, `barcode`, а также сгруппированные атрибуты (монография, ярлыки, аналоги и пр.).

- Фоновые задачи Celery
  - Уже есть: `pull_products`, `pull_product_details`, `sync_categories_and_brands`, `full_catalog_sync`.
  - Добавить:
    - `sync_prices_current`, `sync_prices_scheduled`.
    - `sync_documents`, `sync_monograph`, `sync_equivalents_and_alternatives`.
  - Во всех задачах сохранять данные в модели/атрибуты, вести историю цен.

- API и Swagger
  - Сохранить `drf-spectacular` (уже используется). Документировать новые поля/эндпоинты.
  - Публичные read-эндпоинты:
    - Каталог: список/деталь товара (уже есть) — дополнить полями.
    - Поиск + подсказки (суггест) — использовать vapi search для обогащения, кэшировать.
    - Документы/монография/аналоги — отдавать внутри `ProductDetail` или отдельными ресурсами.
  - Сервисные эндпоинты `apps/vapi/views.py` оставить для запуска фоновых синхронизаций.

- Локализация
  - Прокидывать язык до vapi через `Accept-Language`.
  - На фронте — показывать тексты UI через `t(...)`, данные — как приходят от API на выбранной локали. Фолбэк: если vapi не вернул локализованный текст — показывать исходный и/или авто‑перевод (опционально, позже).

- Фронтенд
  - Детальная карточка: вывести монографию, документы (ссылки/скачивание), аналоги/альтернативы, ярлыки пациента, дозировки.
  - Поиск: использовать подсказки от vapi, кэшировать запросы.
  - Все новые тексты — в `common.json`.

- Эксплуатация и стабильность
  - Таймауты/ретраи в `VapiClient` есть — расширить при новых методах.
  - Кэширование ответов (на уровне сервиса/Redis) для часто дергаемых ресурсов (категории, бренды, суггест).
  - Бэкоф при ошибках и метрики.

Если ок, начну с:
- Добавления `Accept-Language` в `VapiClient` и прокидывания локали.
- Реализации методов для цен, документов, монографии, аналогов/альтернатив.
- Расширения нормализатора для сохранения этих данных и дополнения `ProductDetailSerializer`.

