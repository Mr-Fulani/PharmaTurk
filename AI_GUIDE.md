# Документация AI-модуля PharmaTurk

AI-модуль предназначен для автоматической обработки товаров, поступающих от парсеров. Он генерирует описания, определяет категории и анализирует изображения.

---

## 1. Архитектура системы

Модуль интегрирован в экосистему Django + Celery и использует внешние сервисы:
- **LLM (OpenAI/Local)**: Генерация текста, анализ изображений и извлечение атрибутов.
- **Qdrant**: Векторная база данных для RAG (поиск похожих категорий и шаблонов).
- **Cloudflare R2**: Хранение и оптимизация медиафайлов.
- **Celery**: Асинхронная обработка очередей.

### Схема потока данных
1. **Парсер** сохраняет "сырой" товар.
2. **Сигнал** `post_save` (или прямой вызов) создает задачу Celery `process_product_ai`.
3. **AI Worker**:
   - Скачивает и оптимизирует изображения из R2.
   - Анализирует изображения (Vision API) для извлечения бренда, издательства и характеристик.
   - Определяет категорию (RAG + LLM).
   - Генерирует описание, SEO и извлекает атрибуты (Автор, Страницы, Цена и др.).
   - Автоматически скачивает изображения по ссылкам из текста и сохраняет в R2.
4. **Результат** сохраняется в `AIProcessingLog` и применяется к товару.
5. **Применение**:
   - Обновляются поля товара (название, описание, SEO).
   - Создаются/привязываются сущности: Автор, Бренд.
   - Обновляется цена и запускается пересчет валют.

---

## 2. Основные компоненты

### 2.1 Модели данных (`apps/ai/models.py`)

- **`AIProcessingLog`**: Основной журнал обработки. Хранит:
  - Входные данные (JSON).
  - Результаты (заголовки, описания, SEO, категории, извлеченные атрибуты).
  - Метрики (стоимость, токены, время).
  - Статус (`pending`, `processing`, `completed`, `moderation`, `approved`, `failed`).
- **`AITemplate`**: Шаблоны промптов и примеры для few-shot learning.
- **`AIModerationQueue`**: Очередь для ручной проверки сомнительных результатов.

### 2.2 Сервисы (`apps/ai/services/`)

- **`ContentGenerator`**: Оркестратор. Запускает весь пайплайн обработки.
  - **Извлечение атрибутов**: Автор, Страницы, ISBN, Издательство, Тип обложки.
  - **Работа с ценами**: Извлечение цены и валюты -> автоматическая конвертация во все валюты магазина.
  - **Работа с брендами**: Поиск бренда по имени -> создание нового бренда при отсутствии.
  - **Медиа**: Скачивание изображений из ссылок в тексте -> сохранение в R2 через `ProductImage`.
- **`LLMClient`**: Унифицированный клиент к OpenAI (GPT-4o, Vision). Поддерживает подсчет токенов и стоимости.
- **`R2MediaProcessor`**: Работа с Cloudflare R2. Скачивает, оптимизирует и кэширует изображения для Vision API.
- **`QdrantManager`**: Работа с векторной БД. Поиск похожих категорий по эмбеддингам.
- **`AutoCategorizer`**: Логика определения категории товара.

---

## 3. Интеграция с R2 (Медиа)

AI-модуль тесно связан с R2 для анализа изображений:
- Используются настройки `AI_R2_SETTINGS` в `settings.py`.
- Изображения для анализа сохраняются в `products/processed/`.
- Превью (thumbnails) в `products/thumbs/`.

**Важно:** Модуль не скачивает файлы на локальный диск сервера надолго, все операции происходят в памяти или с временными файлами, которые сразу уходят в R2.

---

## 4. Celery Задачи (`apps/ai/tasks.py`)

- **`process_product_ai(product_id, **options)`**: Обработка одного товара.
- **`batch_process_products(product_ids)`**: Пакетная обработка.
- **`process_uncategorized`**: Периодическая задача для товаров без категории.
- **`process_without_description`**: Периодическая задача для товаров без описания.

---

## 5. Использование

### 5.1 Автоматический запуск
При парсинге товаров через `BaseParser` или сигналы, задача создается автоматически:

```python
# В коде парсера или сигнала
process_product_ai.delay(
    product.id,
    generate_description=True,
    categorize=True,
    analyze_images=True
)
```

### 5.2 Ручной запуск (через API)
`POST /api/ai/process/{product_id}/`
Body:
```json
{
    "description": true,
    "categorize": true,
    "images": true
}
```

### 5.3 Ручной запуск (через админку — сессии парсинга)
1. Откройте **Admin Panel → Scrapers → Scraping sessions**.
2. Найдите нужную сессию и нажмите кнопку **«Запустить AI»** в колонке действий.
3. Система возьмёт товары из логов сессии со статусом `created` или `updated` и поставит их в очередь AI.
4. Результаты появляются в **Admin Panel → AI module → Логи AI обработки**.

**Важно:** кнопка не запускает повторный парсинг, а только AI-обработку товаров, уже созданных/обновлённых в этой сессии.

### 5.4 Модерация
В админ-панели доступен интерфейс для просмотра логов и очереди модерации.
- **Approve**: Применяет сгенерированные данные к товару.
- **Reject**: Отклоняет результат.
- **Reprocess**: Запускает обработку заново.

### 5.5 Шаблоны AI (AITemplate)
Шаблоны используются для управления качеством промптов и few-shot примеров.

**Где настраивать:**
1. Откройте **Admin Panel → AI module → AI шаблоны**.
2. Создайте или отредактируйте шаблон.

**Как заполнять:**
- **Template type** определяет назначение:
  - `description` — описание товара
  - `category_example` — пример для категоризации
  - `attribute_extraction` — извлечение атрибутов
  - `image_prompt` — анализ изображения
- **Content** — текст шаблона/примера, который подставляется в промпт.
- **Language** и **Category** используются для управления и аналитики в админке.
- **Is active** включает шаблон в использование.

**Как используется в коде:**
- При генерации система берёт **первый активный** шаблон по `template_type`.
- Если активных шаблонов нет, используется дефолтный встроенный промпт.

---

## 6. Настройка окружения (.env)

Для работы модуля необходимы переменные:

```bash
# OpenAI
OPENAI_API_KEY=sk-...
AI_MODEL=gpt-4o-mini
AI_VISION_MODEL=gpt-4o-mini

# Qdrant (Векторная БД)
QDRANT_HOST=qdrant
QDRANT_PORT=6333

# R2 (уже настроен в основном конфиге)
```
