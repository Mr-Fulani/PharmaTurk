# Celery Beat: задачи по расписанию

Список задач, которые **не тратят токены OpenAI**. AI-задачи (категоризация, описания, повтор неудачных) только вручную — `/admin/ai/manual-tasks/`.

---

## Задачи в работе

### currency-update-rates
**Расписание:** каждые 4 часа

**Что делает:** Обновление курсов валют из внешнего источника (API). Сохраняет в `CurrencyRate`.

**Текущее состояние:** Работает. Использует `CurrencyRateService`.

---

### currency-update-prices
**Расписание:** раз в день

**Что делает:** Пересчитывает цены товаров по актуальным курсам валют. Обходит товары батчами (batch_size=200).

**Текущее состояние:** Работает. Вызывает management-команду `update_product_prices`.

---

### cleanup-scraper-sessions
**Расписание:** раз в неделю

**Что делает:** Удаляет старые сессии парсинга (`ScrapingSession`) и логи (`ScrapedProductLog`) старше 30 дней.

**Текущее состояние:** Работает. Освобождает БД от старых логов парсинга.

**Что нужно:** Решить — оставить 30 дней или изменить срок хранения.

---

### find-merge-duplicates
**Расписание:** раз в день

**Что делает:** Ищет дубликаты товаров (по названию/данным) между API-товарами и распарсенными. Объединяет дубликаты — оставляет один основной товар, остальные привязывает к нему.

**Текущее состояние:** Работает. Сравнение строк, без AI.

**Ручной запуск:** Массовое действие «Поиск и объединение дубликатов» в админке на страницах товаров (любой тип: лекарства, одежда, обувь, книги и т.д.). Выберите товары, выберите действие → «Поиск и объединение дубликатов» → применить. Задача всегда идёт по всему каталогу.

**Что нужно:** Решить — оставить, отключить или менять частоту. Может быть тяжёлой при большом каталоге.

---

### cleanup-orphaned-media
**Расписание:** раз в день

**Что делает:** Удаляет файлы из R2/локального хранилища, на которые нет ссылок в БД. Исключает защищённые пути (AI, temp).

**Текущее состояние:** Работает. Экономит место в storage.

**Что нужно:** Решить — оставить или отключить (если не используете R2/медиа).

---

### ai-cleanup-old-logs
**Расписание:** раз в неделю

**Что делает:** Удаляет завершённые/одобренные логи AI (`AIProcessingLog`) старше 90 дней.

**Текущее состояние:** Работает. Не тратит токены. Можно также запускать вручную в `/admin/ai/manual-tasks/` с нужным количеством дней.

**Что нужно:** Решить — оставить 90 дней или изменить срок.

---

### recsys-sync-all
**Расписание:** раз в сутки

**Что делает:** Полная переиндексация векторов товаров в Qdrant. Использует локальные модели: SentenceTransformer (текст) и CLIP (изображения). Без OpenAI.

**Текущее состояние:** Работает. Нужна для рекомендаций «похожие товары», «дополнить образ» и т.п.

**Что нужно:** Решить — оставить раз в день или менять частоту.

---

## Отключённые задачи

### refresh-stock, run-all-scrapers
**Статус:** Отключено — доработаем после парсеров.

**Что делают:**
- `refresh-stock` — проверка наличия товаров на складе/у поставщиков (каждые 2 ч). Сейчас заглушка — логики нет.
- `run-all-scrapers` — запуск всех активных парсеров (каждые 12 ч). Работает, но временно выключен.

**Как включить:** Раскомментировать блоки в `backend/config/settings.py` → `CELERY_BEAT_SCHEDULE`.

---

### VAPI (vapi-sync-products, vapi-sync-categories, vapi-full-sync)
**Статус:** Отключено — фича не используется.

**Что делают:**
- `vapi-sync-products` — подтягивает товары из VAPI API (каждые 6 ч)
- `vapi-sync-categories` — синхронизирует категории и бренды (раз в день)
- `vapi-full-sync` — полная синхронизация каталога (раз в 3 дня)

**Как включить:** Раскомментировать блок в `backend/config/settings.py` → `CELERY_BEAT_SCHEDULE`. Указать `VAPI_BASE_URL` и `VAPI_API_KEY` в `.env`.

---

## Дополнительные задачи (не в Beat)

- `currency.cleanup_old_logs` — очистка старых логов курсов (можно добавить в расписание)
- `currency.health_check` — проверка здоровья системы валют
- `index_product_vectors` — индексация одного/нескольких товаров (вызывается при сохранении товара или через `sync_all_products_to_qdrant`)
